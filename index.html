<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>Mimi Danmaku</title>
<style>
body {
	background-attachment: fixed;
	text-align: center;
	font-family: Verdana, "Helvetica Neue", Arial, "PingFang SC", "Microsoft YaHei", sans-serif;
	min-width: 960px;
}
span {
	color: #FFFFFF;
}
</style>
</head>
<body>
	<div style="position: fixed; bottom: 20px; left: 20px; z-index: 100; opacity: 0.9;">
		<img src="images/galaxymimi.svg" style="width: 200px; border-radius: 20px;">
		<br>
		<span>Mimi弹幕</span>
		<br>
		<span id="channel"></span>
	</div>
<script>
/*
const { dialog } = require("electron").remote;
function message(msg) {
	dialog.showMessageBox({message : msg});
}*/
const { ipcRenderer } = require("electron");

ipcRenderer.on("background", (event, message) => { // 监听父页面定义的端口
	canvas.style.cssText = "position: fixed; top: 0; left: 0; background-size: cover; z-index: -1;";
	if (message) canvas.style.cssText += ` background-image: url(${Bg});`;
});

ipcRenderer.on("setchannel", (event, message) => {
	document.getElementById("channel").innerHTML = "频道：" + message;
	document.getElementsByTagName("img")[0].src = "https://api.pkupi.com/qrcode/?margin=3&text=https://mimichat.herokuapp.com/danmaku/?channel=" + message;
});

ipcRenderer.on("danmaku", (event, message) => {
	var messageArray = JSON.parse(message).content.split("|");
	output.push(createDanmaku(...messageArray));
});

ipcRenderer.on("remove", (event, message) => {
	var messageArray = JSON.parse(message).content.split("|");
	for (let i in output) {
		output[i].x -= output[i].speed;
		if (output[i].text === messageArray[0]) {
			output.splice(i, 1); //会删除所有相同弹幕
		}
	}
});

var output = [];

var canvas = document.createElement("canvas");
var context = canvas.getContext("2d");
document.getElementsByTagName("body")[0].appendChild(canvas);

var availableBg = ["sky.jpg", "bg1.jpg", "bg2.jpg"];
var Bg = "images/" + availableBg[Math.floor(Math.random() * availableBg.length)];

var W = window.innerWidth;
var H = window.innerHeight;
canvas.width = W;
canvas.height = H;
var fontSize = H / 10;

var availableColor = ["orange", "red", "blue", "purple", "green", "white"];

window.onresize = function() {
	console.warn("WTF?");
  	W = window.innerWidth;
  	H = window.innerHeight;
  	canvas.width = W;
  	canvas.height = H;
  	fontSize = H / 10;
}

function createDanmaku(text, size, color) {
	var danmaku = {
		speed: (W / 500) * (Math.random() * 0.5 + 0.75),
		x    : W,
		y    : Math.random() * H * 4 / 5 + fontSize,
		text : text,
		size : fontSize * size
	};
	var reg = new RegExp("^#([0-9a-fA-F]{6}|[0-9a-fA-F]{3})$");
	danmaku.color = reg.test(color) ? color : availableColor[Math.floor(Math.random() * availableColor.length)];
	return danmaku;
}

function draw(obj) {
	context.font = `700 ${obj.size}px Microsoft YaHei`;
	context.fillStyle = obj.color;
	context.fillText(obj.text, obj.x, obj.y);
}

setInterval(() => {
	context.clearRect(0, 0, W, H);
	for (let i in output) {
		draw(output[i]);
		output[i].x -= output[i].speed;
		if (output[i].x < -context.measureText(output[i].text).width) {
			output.splice(i, 1);
			console.log(i);
		}
	}
}, 20);
</script>
</body>
</html>
